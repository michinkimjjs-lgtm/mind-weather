<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆìŒ ë‚ ì”¨ (Mind Weather) - Preview</title>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        body {
            font-family: 'Pretendard', sans-serif;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #4A4A4A;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            min-height: 100dvh;
            transition: background 1s ease;
        }

        /* Dynamic Backgrounds */
        body.sunny {
            background: linear-gradient(120deg, #f6d365 0%, #fda085 100%);
        }

        body.cloudy {
            background: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%);
        }

        body.rainy {
            background: linear-gradient(to top, #30cfd0 0%, #330867 100%);
            color: white;
        }

        body.stormy {
            background: linear-gradient(to top, #232526, #414345);
            color: white;
        }

        body.snowy {
            background: linear-gradient(to top, #e6e9f0 0%, #eef1f5 100%);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .app-container {
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.6);
            /* Semi-transparent base */
            backdrop-filter: blur(10px);
            height: 100vh;
            height: 100dvh;
            max-height: 850px;
            position: relative;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* App Bar */
        .app-bar {
            padding: 16px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }

        /* Screens */
        .screen {
            flex: 1;
            display: none;
            flex-direction: column;
            padding: 24px;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Text Area */
        textarea {
            width: 100%;
            flex: 1;
            border: none;
            padding: 20px;
            border-radius: 20px;
            background: white;
            font-family: inherit;
            font-size: 16px;
            line-height: 1.6;
            resize: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        textarea:focus {
            outline: none;
        }

        /* Buttons */
        .btn {
            background-color: #AEC6CF;
            /* Pastel Blue */
            color: white;
            border: none;
            padding: 16px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-mint {
            background-color: #B5EAD7;
            color: #4A4A4A;
        }

        .btn-pink {
            background-color: #FFB7B2;
        }

        /* Initial Screen (Input) */
        h2 {
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        /* Result Screen */
        .result-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .weather-icon {
            width: 200px;
            height: 200px;
            object-fit: contain;
            margin: 20px 0;
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                transform: scale(0);
            }

            to {
                transform: scale(1);
            }
        }

        .mood-text {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 50px;
        }

        /* Cloud Loader */
        .loader-cloud {
            width: 50px;
            height: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 100px;
            position: relative;
            margin: 10px auto;
            animation: pulse-cloud 1.5s ease-in-out infinite;
        }

        .loader-cloud:after,
        .loader-cloud:before {
            content: '';
            position: absolute;
            background: inherit;
        }

        .loader-cloud:after {
            width: 20px;
            height: 20px;
            top: -10px;
            left: 8px;
            border-radius: 100px;
        }

        .loader-cloud:before {
            width: 25px;
            height: 25px;
            top: -15px;
            right: 5px;
            border-radius: 100px;
        }

        @keyframes pulse-cloud {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
                box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            }

            100% {
                transform: scale(1);
                opacity: 0.8;
            }
        }

        /* Navigation */
        .nav-bar {
            position: absolute;
            bottom: 0;
            width: 100%;
            display: flex;
            border-top: 1px solid #eee;
            background: white;
        }

        .nav-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            font-size: 16px;
            cursor: pointer;
            color: #aaa;
        }

        .nav-btn.active {
            color: #AEC6CF;
            font-weight: bold;
        }

        /* Calendar Styles */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            text-align: center;
        }

        .day-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            position: relative;
        }

        .day-icon {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <div class="app-bar">Mind Weather</div>

        <!-- Input Screen -->
        <div id="inputScreen" class="screen active">
            <!-- Daily Question -->
            <div id="dailyQuestion" style="margin-bottom: 15px; font-size: 18px; color: #555; font-weight: 500;">
                ì˜¤ëŠ˜ í•˜ë£¨, ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ìˆœê°„ì€ ì–¸ì œì˜€ë‚˜ìš”?
            </div>

            <!-- Mood Primer -->
            <div class="mood-primer"
                style="display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom:5px;">
                <button onclick="setMoodPrimer('sunny')"
                    style="font-size:24px; border:none; background:none; cursor:pointer; opacity: 0.7;">ğŸ˜Š</button>
                <button onclick="setMoodPrimer('cloudy')"
                    style="font-size:24px; border:none; background:none; cursor:pointer; opacity: 0.7;">ğŸ˜</button>
                <button onclick="setMoodPrimer('rainy')"
                    style="font-size:24px; border:none; background:none; cursor:pointer; opacity: 0.7;">ğŸ˜¢</button>
                <button onclick="setMoodPrimer('stormy')"
                    style="font-size:24px; border:none; background:none; cursor:pointer; opacity: 0.7;">ğŸ˜¡</button>
                <button onclick="setMoodPrimer('snowy')"
                    style="font-size:24px; border:none; background:none; cursor:pointer; opacity: 0.7;">ğŸ˜Œ</button>
            </div>

            <textarea id="diaryInput" class="glass-panel" placeholder="ì—¬ê¸°ì— ì†”ì§í•œ ë§ˆìŒì„ ì ì–´ì£¼ì„¸ìš”..."
                style="background: rgba(255,255,255,0.4);"></textarea>
            <button class="btn" onclick="analyzeMood()">
                <span id="btnText">ë§ˆìŒ ë‚ ì”¨ ë¶„ì„í•˜ê¸°</span>
                <div id="loader" class="loader-cloud" style="display: none;"></div>
            </button>
        </div>

        <!-- Result Screen -->
        <div id="resultScreen" class="screen">
            <div class="result-content">
                <div style="color: grey; font-size: 22px;">ì˜¤ëŠ˜ì˜ ë§ˆìŒ ë‚ ì”¨ëŠ”...</div>
                <img id="resultIcon" class="weather-icon" src="" alt="Weather Icon">
                <div id="resultText" class="mood-text">ë§‘ìŒ (í–‰ë³µ)</div>
            </div>

            <button class="btn btn-mint" onclick="saveEntry()" style="margin-bottom: 10px;">ì¼ê¸°ì¥ì— ê¸°ë¡í•˜ê¸°</button>
            <button class="btn" style="background: transparent; color: grey; box-shadow:none;" onclick="resetApp()">ë‹¤ì‹œ
                ì“°ê¸°</button>
        </div>

        <!-- Calendar Screen -->
        <div id="calendarScreen" class="screen" style="padding-bottom: 70px;">
            <div class="calendar-header glass-panel" style="padding: 10px 20px; margin-bottom: 20px;">
                <button onclick="changeMonth(-1)"
                    style="border:none; background:none; cursor:pointer; font-size:18px;">&lt;</button>
                <span id="monthLabel">2024ë…„ 1ì›”</span>
                <button onclick="changeMonth(1)"
                    style="border:none; background:none; cursor:pointer; font-size:18px;">&gt;</button>
            </div>

            <div class="glass-panel" style="padding: 15px; margin-bottom: 20px;">
                <div class="calendar-grid" id="calendarGrid">
                    <!-- JS will populate this -->
                </div>
            </div>

            <!-- Monthly Report -->
            <div id="monthlyReport" class="glass-panel" style="padding: 15px; font-size: 14px; color: #555;">
                <div style="font-weight: bold; margin-bottom: 10px;">ì´ë²ˆ ë‹¬ì˜ ë§ˆìŒ ë‚ ì”¨</div>
                <div id="moodSummary" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-bar">
            <button class="nav-btn active" onclick="switchTab('home')">ğŸ  í™ˆ</button>
            <button class="nav-btn" onclick="switchTab('calendar')">ğŸ“… ë‹¬ë ¥</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        const API_KEY = "AIzaSyDEeHRj5MFU6SKX6p5zxozIa8EnwpFBCxU"; // The key provided
        const genAI = new GoogleGenerativeAI(API_KEY);

        // Supabase Configuration
        const SUPABASE_URL = 'https://ofhliqfzdbiwmwsfkrpk.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_x-l-Q-jwO6xtHxt9C2ErsA_mzO7q2X7';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Initial State
        let currentDate = new Date();
        let currentMoodData = {};

        // Helper: Load data from Supabase
        async function loadData() {
            try {
                const { data, error } = await supabase
                    .from('diaries')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Transform list to map: { "YYYY-MM-DD": { type, text } }
                currentMoodData = {};
                if (data) {
                    data.forEach(entry => {
                        // created_at is UTC ISO string. 
                        // We want local date string for the calendar key.
                        const localDate = new Date(entry.created_at);
                        const year = localDate.getFullYear();
                        const month = String(localDate.getMonth() + 1).padStart(2, '0');
                        const day = String(localDate.getDate()).padStart(2, '0');
                        const dateStr = `${year}-${month}-${day}`;

                        // Only keep the latest one per day if duplicates exist (though UI prevents easy dupes)
                        if (!currentMoodData[dateStr]) {
                            currentMoodData[dateStr] = {
                                type: entry.mood,
                                text: entry.content
                            };
                        }
                    });
                }
                renderCalendar();
            } catch (e) {
                console.error("Supabase Load Error:", e);
            }
        }

        // Helper: Save data to Supabase
        async function saveData(dateStr, type, text) {
            try {
                // We use current time for created_at, but we might want to respect the dateStr if editing past?
                // For simplicity, we just insert a new record with current timestamp (UTC).
                const { error } = await supabase
                    .from('diaries')
                    .insert({
                        content: text,
                        mood: type,
                        // created_at will default to now() in DB, which is UTC
                    });

                if (error) throw error;

                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");

                // Reload data to reflect change
                await loadData();
            } catch (e) {
                console.error("Supabase Save Error:", e);
                alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + e.message);
            }
        }

        window.analyzeMood = async function () {
            const textArea = document.getElementById('diaryInput');
            const text = textArea.value;

            if (!text.trim()) {
                alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            const btnText = document.getElementById('btnText');
            const loader = document.getElementById('loader');

            // UI Loading State
            btnText.style.display = 'none';
            loader.style.display = 'block';

            let weatherType = 'cloudy'; // Fallback default

            try {
                // Create a timeout race condition (8 seconds)
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error("Request timed out")), 8000)
                );

                const apiPromise = (async () => {
                    const model = genAI.getGenerativeModel({ model: "gemini-pro" });
                    const prompt = `
                  Analyze the sentiment of the following diary entry and classify it into exactly one of these weather categories:
                  - sunny (for happy, joy, positive, excited)
                  - cloudy (for neutral, bored, anxious, confused)
                  - rainy (for sad, depressed, melancholic, crying)
                  - stormy (for angry, frustrated, stressed, mad)
                  - snowy (for calm, peaceful, cool, relaxed)

                  Diary entry: "${text}"

                  Return ONLY the category name in lowercase.
                `;

                    const result = await model.generateContent(prompt);
                    const response = await result.response;
                    const textResult = response.text().trim().toLowerCase();
                    return textResult;
                })();

                // Race API against Timeout
                const textResult = await Promise.race([apiPromise, timeoutPromise]);

                if (textResult) {
                    if (['sunny', 'cloudy', 'rainy', 'stormy', 'snowy'].some(w => textResult.includes(w))) {
                        ['sunny', 'cloudy', 'rainy', 'stormy', 'snowy'].forEach(w => {
                            if (textResult.includes(w)) weatherType = w;
                        });
                    }
                }

            } catch (error) {
                console.error("Analysis Error:", error);
                // Fallback logic if API fails or times out
                if (text.includes('í–‰ë³µ') || text.includes('ì¢‹ì•„') || text.includes('ê¸°ë»')) weatherType = 'sunny';
                else if (text.includes('ìŠ¬í¼') || text.includes('ìš°ìš¸') || text.includes('ëˆˆë¬¼')) weatherType = 'rainy';
                else if (text.includes('í™”ë‚˜') || text.includes('ì§œì¦') || text.includes('ë¶„ë…¸')) weatherType = 'stormy';
                else if (text.includes('í¸ì•ˆ') || text.includes('í‰ì˜¨') || text.includes('íœ´ì‹')) weatherType = 'snowy';
                // else remains 'cloudy'
            } finally {
                // THIS BLOCK ALWAYS RUNS
                showResult(weatherType, text);

                // Reset loading state
                btnText.style.display = 'block';
                loader.style.display = 'none';
            }
        }

        window.showResult = function (type, text) {
            document.getElementById('inputScreen').classList.remove('active');
            document.getElementById('resultScreen').classList.add('active');

            const icon = document.getElementById('resultIcon');
            const label = document.getElementById('resultText');

            // Sync background with result
            document.body.className = type;

            icon.src = `assets/images/${type}.png`;

            const labels = {
                'sunny': 'ë§‘ìŒ (í–‰ë³µ)',
                'cloudy': 'íë¦¼ (ê±±ì •/í‰ë²”)',
                'rainy': 'ë¹„ (ìš°ìš¸/ìŠ¬í””)',
                'stormy': 'ë²ˆê°œ (í™”ë‚¨)',
                'snowy': 'ëˆˆ (í‰ì˜¨)'
            };
            label.innerText = labels[type] || 'íë¦¼';

            // Update the tempSave function for the current entry
            window.tempSave = () => {
                const today = new Date().toISOString().split('T')[0];
                saveData(today, type, text);

                // Clear input and go to calendar
                document.getElementById('diaryInput').value = '';
                switchTab('calendar');
            };
        }

        window.saveEntry = function () {
            if (window.tempSave) window.tempSave();
        }

        window.resetApp = function () {
            document.getElementById('resultScreen').classList.remove('active');
            document.getElementById('inputScreen').classList.add('active');
        }

        // Calendar Logic
        window.renderCalendar = function () {
            const grid = document.getElementById('calendarGrid');
            const monthLabel = document.getElementById('monthLabel');
            grid.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            monthLabel.innerText = `${year}ë…„ ${month + 1}ì›”`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Empty cells for padding
            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Counts for report
            const counts = { 'sunny': 0, 'cloudy': 0, 'rainy': 0, 'stormy': 0, 'snowy': 0 };

            // Days
            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                cell.onclick = () => { if (currentMoodData[dateStr]) alert(currentMoodData[dateStr].text); };

                const dayNum = document.createElement('span');
                dayNum.innerText = i;
                cell.appendChild(dayNum);

                if (currentMoodData[dateStr]) {
                    const type = currentMoodData[dateStr].type;
                    counts[type] = (counts[type] || 0) + 1;

                    // Heatmap background
                    const bgColors = {
                        'sunny': '#fff5e6', 'cloudy': '#f0f4f8', 'rainy': '#e0f7fa',
                        'stormy': '#eceff1', 'snowy': '#f1f8e9'
                    };
                    cell.style.backgroundColor = bgColors[type] || 'transparent';
                    cell.style.borderRadius = '10px';

                    const img = document.createElement('img');
                    img.src = `assets/images/${type}.png`;
                    img.className = 'day-icon';
                    cell.appendChild(img);

                    dayNum.style.fontSize = '10px';
                    dayNum.style.position = 'absolute';
                    dayNum.style.top = '2px';
                    dayNum.style.left = '5px';
                    dayNum.style.color = '#555';
                }

                grid.appendChild(cell);
            }

            // Render Report
            const summaryEl = document.getElementById('moodSummary');
            summaryEl.innerHTML = '';
            const labels = {
                'sunny': 'í–‰ë³µ', 'cloudy': 'í‰ë²”', 'rainy': 'ìš°ìš¸',
                'stormy': 'í™”ë‚¨', 'snowy': 'í‰ì˜¨'
            };

            // Calculate max to find dominant mood
            let maxType = 'sunny';
            let maxVal = -1;

            ['sunny', 'cloudy', 'rainy', 'stormy', 'snowy'].forEach(type => {
                if (counts[type] > 0) {
                    const pill = document.createElement('span');
                    pill.innerText = `${labels[type]} ${counts[type]}ì¼`;
                    pill.style.background = 'rgba(255,255,255,0.5)';
                    pill.style.padding = '5px 10px';
                    pill.style.borderRadius = '15px';
                    pill.style.fontSize = '12px';
                    summaryEl.appendChild(pill);

                    if (counts[type] > maxVal) { maxVal = counts[type]; maxType = type; }
                }
            });

            // Set background to dominant mood of the month if in Calendar view? 
            // Maybe not, might be confusing if user came from a specific result interaction.
            // Let's keep the manual background switch or default.
        }

        window.changeMonth = function (delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        window.switchTab = function (tab) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            if (tab === 'home') {
                document.getElementById('inputScreen').classList.add('active');
                document.querySelectorAll('.nav-btn')[0].classList.add('active');
                // If we were in result, we stay there? No, usually home means input
                // But let's check validation. For simplicity, Home = Input.
            } else if (tab === 'calendar') {
                document.getElementById('calendarScreen').classList.add('active');
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
                renderCalendar();
            }
        }

        // Mood Primer Logic
        window.setMoodPrimer = function (mood) {
            document.body.className = mood; // Change background immediately
            // Highlight selected icon
            const map = { 'sunny': 0, 'cloudy': 1, 'rainy': 2, 'stormy': 3, 'snowy': 4 };
            const buttons = document.querySelectorAll('.mood-primer button');
            buttons.forEach(b => { b.style.opacity = '0.5'; b.style.transform = 'scale(1)'; });

            if (map[mood] !== undefined) {
                buttons[map[mood]].style.opacity = '1.0';
                buttons[map[mood]].style.transform = 'scale(1.2)';
            }
        }

        // Init
        loadData();
        renderCalendar();

        // Random Daily Question
        const questions = [
            "ì˜¤ëŠ˜ í•˜ë£¨, ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ìˆœê°„ì€ ì–¸ì œì˜€ë‚˜ìš”?",
            "ì§€ê¸ˆ ë– ì˜¤ë¥´ëŠ” ê°ì •ì„ ìƒ‰ê¹”ë¡œ í‘œí˜„í•œë‹¤ë©´?",
            "ì˜¤ëŠ˜ ë‚˜ì—ê²Œ í•´ì£¼ê³  ì‹¶ì€ ìœ„ë¡œì˜ ë§ì€?",
            "ìµœê·¼ì— ê°€ì¥ ê°ì‚¬í–ˆë˜ ì¼ì€ ë¬´ì—‡ì¸ê°€ìš”?",
            "ì˜¤ëŠ˜ ë‹¹ì‹ ì„ ë¯¸ì†Œ ì§“ê²Œ ë§Œë“  ê²ƒì€?"
        ];
        document.getElementById('dailyQuestion').innerText = questions[Math.floor(Math.random() * questions.length)];

    </script>

</body>

</html>