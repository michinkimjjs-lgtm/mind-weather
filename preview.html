<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎßàÏùå ÎÇ†Ïî® (Mind Weather) - Preview</title>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #FFF9F0;
            color: #4A4A4A;
            margin: 0;
            display: flex;
            justify_content: center;
            align-items: center;
            min-height: 100vh;
        }

        .app-container {
            width: 100%;
            max-width: 400px;
            background-color: #FFF9F0;
            height: 100vh;
            max-height: 850px;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* App Bar */
        .app-bar {
            padding: 16px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }

        /* Screens */
        .screen {
            flex: 1;
            display: none;
            flex-direction: column;
            padding: 24px;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Text Area */
        textarea {
            width: 100%;
            flex: 1;
            border: none;
            padding: 20px;
            border-radius: 20px;
            background: white;
            font-family: inherit;
            font-size: 16px;
            line-height: 1.6;
            resize: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        textarea:focus {
            outline: none;
        }

        /* Buttons */
        .btn {
            background-color: #AEC6CF;
            /* Pastel Blue */
            color: white;
            border: none;
            padding: 16px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-mint {
            background-color: #B5EAD7;
            color: #4A4A4A;
        }

        .btn-pink {
            background-color: #FFB7B2;
        }

        /* Initial Screen (Input) */
        h2 {
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        /* Result Screen */
        .result-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .weather-icon {
            width: 200px;
            height: 200px;
            object-fit: contain;
            margin: 20px 0;
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                transform: scale(0);
            }

            to {
                transform: scale(1);
            }
        }

        .mood-text {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 50px;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #AEC6CF;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Navigation */
        .nav-bar {
            position: absolute;
            bottom: 0;
            width: 100%;
            display: flex;
            border-top: 1px solid #eee;
            background: white;
        }

        .nav-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            font-size: 16px;
            cursor: pointer;
            color: #aaa;
        }

        .nav-btn.active {
            color: #AEC6CF;
            font-weight: bold;
        }

        /* Calendar Styles */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            text-align: center;
        }

        .day-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            position: relative;
        }

        .day-icon {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <div class="app-bar">Mind Weather</div>

        <!-- Input Screen -->
        <div id="inputScreen" class="screen active">
            <h2>Ïò§Îäò ÌïòÎ£®Îäî Ïñ¥Îï†ÎÇòÏöî?</h2>
            <textarea id="diaryInput" placeholder="Ïó¨Í∏∞Ïóê ÏÜîÏßÅÌïú ÎßàÏùåÏùÑ Ï†ÅÏñ¥Ï£ºÏÑ∏Ïöî..."></textarea>
            <button class="btn" onclick="analyzeMood()">
                <span id="btnText">ÎßàÏùå ÎÇ†Ïî® Î∂ÑÏÑùÌïòÍ∏∞</span>
                <div id="loader" class="loader" style="display: none;"></div>
            </button>
        </div>

        <!-- Result Screen -->
        <div id="resultScreen" class="screen">
            <div class="result-content">
                <div style="color: grey; font-size: 22px;">Ïò§ÎäòÏùò ÎßàÏùå ÎÇ†Ïî®Îäî...</div>
                <img id="resultIcon" class="weather-icon" src="" alt="Weather Icon">
                <div id="resultText" class="mood-text">ÎßëÏùå (ÌñâÎ≥µ)</div>
            </div>

            <button class="btn btn-mint" onclick="saveEntry()" style="margin-bottom: 10px;">ÏùºÍ∏∞Ïû•Ïóê Í∏∞Î°ùÌïòÍ∏∞</button>
            <button class="btn" style="background: transparent; color: grey; box-shadow:none;" onclick="resetApp()">Îã§Ïãú
                Ïì∞Í∏∞</button>
        </div>

        <!-- Calendar Screen -->
        <div id="calendarScreen" class="screen" style="padding-bottom: 70px;">
            <div class="calendar-header">
                <button onclick="changeMonth(-1)" style="border:none; background:none; cursor:pointer;">&lt;</button>
                <span id="monthLabel">2024ÎÖÑ 1Ïõî</span>
                <button onclick="changeMonth(1)" style="border:none; background:none; cursor:pointer;">&gt;</button>
            </div>
            <div class="calendar-grid" id="calendarGrid">
                <!-- JS will populate this -->
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-bar">
            <button class="nav-btn active" onclick="switchTab('home')">üè† Ìôà</button>
            <button class="nav-btn" onclick="switchTab('calendar')">üìÖ Îã¨Î†•</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        const API_KEY = "AIzaSyDEeHRj5MFU6SKX6p5zxozIa8EnwpFBCxU"; // The key provided
        const genAI = new GoogleGenerativeAI(API_KEY);

        // Initial State
        let currentDate = new Date();
        let currentMoodData = {};

        // Helper: Load data safely
        function loadData() {
            try {
                const data = localStorage.getItem('mind_weather_data');
                if (data) {
                    currentMoodData = JSON.parse(data);
                }
            } catch (e) {
                console.warn("Î°úÏª¨ Ï†ÄÏû•ÏÜåÎ•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§ (file:// Î≥¥Ïïà Ï†ïÏ±Ö Îì±):", e);
            }
        }

        // Helper: Save data safely
        function saveData(dateStr, type, text) {
            try {
                currentMoodData[dateStr] = { type, text };
                localStorage.setItem('mind_weather_data', JSON.stringify(currentMoodData));
                renderCalendar();
            } catch (e) {
                alert("Î∏åÎùºÏö∞Ï†Ä Î≥¥Ïïà ÏÑ§Ï†ïÏúºÎ°ú Ïù∏Ìï¥ Ï†ÄÏû•Ïù¥ Ï†úÌïúÎê† Ïàò ÏûàÏäµÎãàÎã§.");
            }
        }

        window.analyzeMood = async function () {
            const textArea = document.getElementById('diaryInput');
            const text = textArea.value;

            if (!text.trim()) {
                alert("ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!");
                return;
            }

            const btnText = document.getElementById('btnText');
            const loader = document.getElementById('loader');

            // UI Loading State
            btnText.style.display = 'none';
            loader.style.display = 'block';

            let weatherType = 'cloudy'; // Fallback default

            try {
                // Create a timeout race condition (8 seconds)
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error("Request timed out")), 8000)
                );

                const apiPromise = (async () => {
                    const model = genAI.getGenerativeModel({ model: "gemini-pro" });
                    const prompt = `
                  Analyze the sentiment of the following diary entry and classify it into exactly one of these weather categories:
                  - sunny (for happy, joy, positive, excited)
                  - cloudy (for neutral, bored, anxious, confused)
                  - rainy (for sad, depressed, melancholic, crying)
                  - stormy (for angry, frustrated, stressed, mad)
                  - snowy (for calm, peaceful, cool, relaxed)

                  Diary entry: "${text}"

                  Return ONLY the category name in lowercase.
                `;

                    const result = await model.generateContent(prompt);
                    const response = await result.response;
                    const textResult = response.text().trim().toLowerCase();
                    return textResult;
                })();

                // Race API against Timeout
                const textResult = await Promise.race([apiPromise, timeoutPromise]);

                if (textResult) {
                    if (['sunny', 'cloudy', 'rainy', 'stormy', 'snowy'].some(w => textResult.includes(w))) {
                        ['sunny', 'cloudy', 'rainy', 'stormy', 'snowy'].forEach(w => {
                            if (textResult.includes(w)) weatherType = w;
                        });
                    }
                }

            } catch (error) {
                console.error("Analysis Error:", error);
                // Fallback logic if API fails or times out
                if (text.includes('ÌñâÎ≥µ') || text.includes('Ï¢ãÏïÑ') || text.includes('Í∏∞Îªê')) weatherType = 'sunny';
                else if (text.includes('Ïä¨Ìçº') || text.includes('Ïö∞Ïö∏') || text.includes('ÎààÎ¨º')) weatherType = 'rainy';
                else if (text.includes('ÌôîÎÇò') || text.includes('ÏßúÏ¶ù') || text.includes('Î∂ÑÎÖ∏')) weatherType = 'stormy';
                else if (text.includes('Ìé∏Ïïà') || text.includes('ÌèâÏò®') || text.includes('Ìú¥Ïãù')) weatherType = 'snowy';
                // else remains 'cloudy'
            } finally {
                // THIS BLOCK ALWAYS RUNS
                showResult(weatherType, text);

                // Reset loading state
                btnText.style.display = 'block';
                loader.style.display = 'none';
            }
        }

        window.showResult = function (type, text) {
            document.getElementById('inputScreen').classList.remove('active');
            document.getElementById('resultScreen').classList.add('active');

            const icon = document.getElementById('resultIcon');
            const label = document.getElementById('resultText');

            icon.src = `assets/images/${type}.png`;

            const labels = {
                'sunny': 'ÎßëÏùå (ÌñâÎ≥µ)',
                'cloudy': 'ÌùêÎ¶º (Í±±Ï†ï/ÌèâÎ≤î)',
                'rainy': 'ÎπÑ (Ïö∞Ïö∏/Ïä¨Ìîî)',
                'stormy': 'Î≤àÍ∞ú (ÌôîÎÇ®)',
                'snowy': 'Îàà (ÌèâÏò®)'
            };
            label.innerText = labels[type] || 'ÌùêÎ¶º';

            // Update the tempSave function for the current entry
            window.tempSave = () => {
                const today = new Date().toISOString().split('T')[0];
                saveData(today, type, text);

                // Clear input and go to calendar
                document.getElementById('diaryInput').value = '';
                switchTab('calendar');
            };
        }

        window.saveEntry = function () {
            if (window.tempSave) window.tempSave();
        }

        window.resetApp = function () {
            document.getElementById('resultScreen').classList.remove('active');
            document.getElementById('inputScreen').classList.add('active');
        }

        // Calendar Logic
        window.renderCalendar = function () {
            const grid = document.getElementById('calendarGrid');
            const monthLabel = document.getElementById('monthLabel');
            grid.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            monthLabel.innerText = `${year}ÎÖÑ ${month + 1}Ïõî`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Empty cells for padding
            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Days
            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const cell = document.createElement('div');
                cell.className = 'day-cell';

                const dayNum = document.createElement('span');
                dayNum.innerText = i;
                cell.appendChild(dayNum);

                if (currentMoodData[dateStr]) {
                    const img = document.createElement('img');
                    img.src = `assets/images/${currentMoodData[dateStr].type}.png`;
                    img.className = 'day-icon';
                    img.title = currentMoodData[dateStr].text;
                    cell.appendChild(img);

                    // Adjust number position for readability
                    dayNum.style.fontSize = '10px';
                    dayNum.style.position = 'absolute';
                    dayNum.style.top = '2px';
                    dayNum.style.left = '2px';
                    dayNum.style.color = '#888';
                }

                grid.appendChild(cell);
            }
        }

        window.changeMonth = function (delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        window.switchTab = function (tab) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            if (tab === 'home') {
                document.getElementById('inputScreen').classList.add('active');
                document.querySelectorAll('.nav-btn')[0].classList.add('active');
                // If we were in result, we stay there? No, usually home means input
                // But let's check validation. For simplicity, Home = Input.
            } else if (tab === 'calendar') {
                document.getElementById('calendarScreen').classList.add('active');
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
                renderCalendar();
            }
        }

        // Init
        loadData();
        renderCalendar();

    </script>

</body>

</html>